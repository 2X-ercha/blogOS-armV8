## 中断原理

### 中断是什么

中断是一种硬件机制。简单的说，在cpu执行程序的过程中，突然发生异常 （包括复位、指令错误等等异常，中断只是异常其中一种），可以打断当前正在执行的程序，临时先处理比较紧急的事情，当处理完成了，再回到原来的程序继续执行。

借助于中断，CPU可以不必再采用轮询这种低效的方式访问外部设备。将所有的外部设备与CPU直接相连是不现实的，外部设备的中断请求一般经由中断控制器，由中断控制器仲裁后再转发给CPU。如下图所示Arm的中断系统。

![](https://os2022exps-doc.readthedocs.io/zh_CN/latest/_images/ARMGIC.png)

其中nIRQ是普通中断，nFIQ是快速中断。 Arm采用的中断控制器叫做GIC，即general interrupt controller。

### 中断如何发生

首先，在一个cpu中 中断源有很多（比如gpio中断、定时器中断等等），那么为了管理这些中断，就需要一个中断控制器。
当发生中断时，相应的中断源会给中断控制器发出信号，中断控制器再给cpu发信号，最后cpu处理中断。

### 中断的大概流程

1. 初始化：

    * 使能中断源（允许发生中断）
    
    * 中断控制器可以选择屏蔽或不屏蔽中断，设置中断优先级等

    * cpu 使能中断总开关

2. 中断跳转：

    * cpu 每执行完一条指令就会查看有无异常发生
    
    * 发生异常，cpu 分辩中断源
    
    * cpu 被强制跳转到中断向量表（汇编）中的跳转地址
    
    * 跳转到相应的中断服务函数

3. 中断处理回调函数：

    * 保护现场，保证当前执行的程序能完好返回（存储指令寄存器，以及存数据的寄存器等等各种寄存器，会采用压栈的方式）
    
    * 获取中断id（a7 架构，其中可能还需要切换处理器模式等等），根据id跳转到对应的中断处理函数。
    
    * 中断处理函数可以是我们自己编写的，代表的是中断发生后要处理的事情
    
    * 处理完成，返回中断服务函数。
    
    * 还原现场（将各个寄存器的值还回，指令寄存器需要-4后再返回，这里涉及到arm处理器的3级指令流水线，不做细讲）

下一节将介绍arm架构下的中断控制器`GIC`，介绍GIC如何接收并处理中断。